<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtualized Scroll Window Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the scroll container */
        #scroll-container {
            height: 60vh; /* Fixed height for the viewport */
            overflow-y: scroll;
            border: 2px solid #3b82f6;
            background-color: #f9fafb;
            position: relative; /* Crucial for positioning the items */
        }
        /* The inner list that holds the rendered items */
        #virtual-list {
            position: absolute; /* Allows for manual top-offset positioning */
            top: 0;
            left: 0;
            right: 0;
            padding: 0;
            margin: 0;
            will-change: transform; /* Performance hint for smoother scrolling */
        }
        .list-item {
            height: var(--item-height, 40px); /* Uses CSS Variable defined in JS */
            line-height: var(--item-height, 40px);
            padding: 0 1rem;
            border-bottom: 1px solid #e5e7eb;
            user-select: none;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }
        .list-item:nth-child(even) {
            background-color: #f3f4f6;
        }
        .list-item:hover {
            background-color: #bfdbfe;
        }
        .header-text {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl overflow-hidden">
        <header class="p-5 bg-blue-600 text-white">
            <h1 class="text-2xl font-bold header-text">Virtualized Player Track List</h1>
            <p class="text-sm opacity-80 header-text">Total Tracks: <span id="total-tracks"></span> | Rendered Elements: <span id="rendered-count"></span></p>
        </header>

        <div id="scroll-container" class="p-0">
            <!-- This element is responsible for setting the total scrollable height -->
            <div id="spacer" style="height: 0;"></div>

            <!-- This UL only contains the currently visible LI elements -->
            <ul id="virtual-list">
                <!-- List items will be inserted here -->
            </ul>
        </div>
        
        <footer class="p-3 text-center text-gray-500 text-xs">
            Scroll to observe the rendered count change. Only visible items are in the DOM.
        </footer>
    </div>

    <script>
        const TRACK_COUNT = 10000; // Total number of tracks in the data source
        const ITEM_HEIGHT = 40;     // Height of each list item in pixels
        const BUFFER_ITEMS = 10;    // Number of extra items to render above and below the viewport

        const container = document.getElementById('scroll-container');
        const virtualList = document.getElementById('virtual-list');
        const spacer = document.getElementById('spacer');
        const totalTracksSpan = document.getElementById('total-tracks');
        const renderedCountSpan = document.getElementById('rendered-count');

        // --- 1. DATA GENERATION ---
        // Create an array of mock data items
        const trackData = Array.from({ length: TRACK_COUNT }, (_, i) => ({
            id: i + 1,
            title: `Track Title ${i + 1}`,
            artist: `Artist Name ${Math.floor(i / 10) + 1}`,
        }));

        // --- 2. INITIAL SETUP ---

        // Set the height of the spacer to match the total height of all items
        const totalHeight = TRACK_COUNT * ITEM_HEIGHT;
        spacer.style.height = `${totalHeight}px`;
        totalTracksSpan.textContent = TRACK_COUNT;

        // Set the CSS variable for item height
        document.documentElement.style.setProperty('--item-height', `${ITEM_HEIGHT}px`);

        // Use 'let' for visibleHeight and visibleItems as they need to be reassigned on resize
        let visibleHeight = container.clientHeight;
        let visibleItems = Math.ceil(visibleHeight / ITEM_HEIGHT);

        // --- 3. RENDERING FUNCTION ---

        function updateVisibleItems() {
            // How far down the user has scrolled
            const scrollTop = container.scrollTop;

            // Index of the first item visible in the viewport
            let startIndex = Math.floor(scrollTop / ITEM_HEIGHT);

            // Apply buffer: don't start rendering at the exact top edge
            startIndex = Math.max(0, startIndex - BUFFER_ITEMS);

            // Index of the last item to render
            let endIndex = Math.min(
                TRACK_COUNT,
                startIndex + visibleItems + (2 * BUFFER_ITEMS)
            );

            // Slice the data array to get only the items we need to render
            const itemsToRender = trackData.slice(startIndex, endIndex);

            // --- 4. DOM MANIPULATION (The bottleneck we avoid!) ---

            // Clear the existing list items
            virtualList.innerHTML = '';
            
            // Create new list items
            const fragment = document.createDocumentFragment();
            itemsToRender.forEach(track => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.setAttribute('data-id', track.id);
                li.textContent = `${track.id}. ${track.title} by ${track.artist}`;
                li.onclick = () => console.log(`Playing track: ${track.title}`); // Example click handler
                fragment.appendChild(li);
            });
            virtualList.appendChild(fragment);

            // --- 5. POSITIONING ---

            // Shift the UL container down so the first item appears correctly
            const offset = startIndex * ITEM_HEIGHT;
            virtualList.style.transform = `translateY(${offset}px)`;

            // --- 6. METRICS ---
            renderedCountSpan.textContent = itemsToRender.length;
            console.log(`Rendering from ${startIndex} to ${endIndex}. Total DOM nodes: ${itemsToRender.length}`);
        }

        // --- 7. EVENT LISTENERS ---

        // Crucial: Update the visible items whenever the user scrolls
        container.addEventListener('scroll', updateVisibleItems);

        // Important: Re-calculate visible items if the browser window is resized
        window.addEventListener('resize', () => {
             // Reassigning to 'let' variables is now allowed
             visibleHeight = container.clientHeight; 
             visibleItems = Math.ceil(visibleHeight / ITEM_HEIGHT);
             updateVisibleItems(); // Re-render based on new size
        });


        // Initial call to populate the window on page load
        window.onload = function() {
            // Must calculate visible items AFTER the container has rendered its height
            // Update the outer 'let' variables here to get the correct initial dimensions
            visibleHeight = container.clientHeight;
            visibleItems = Math.ceil(visibleHeight / ITEM_HEIGHT);
            updateVisibleItems();
        }

    </script>
</body>
</html>
